LIBNAME RET_FX "/sasdata/ger_trafego_mkt/RETENCAO/RETENCAO/RETIRADAS/FIXO";
LIBNAME RET_BL "/sasdata/ger_trafego_mkt/RETENCAO/RETENCAO/RETIRADAS/VELOX";
LIBNAME RET_TV "/sasdata/ger_trafego_mkt/RETENCAO/RETENCAO/RETIRADAS/TV";
LIBNAME RET_MV "/sasdata/ger_trafego_mkt/RETENCAO/RETENCAO/RETIRADAS/MOVEL";

/* Carregar o mailing de retorno de Refidel Oi Total e tirar duplicidade por cpf, deixando o registro mais recente */

DATA MAILING_REFIDEL;
SET REFIDELOIT_IV
REFIDELOIT_V_II
REFIDELOIT_VI;
RUN;

PROC SORT DATA=MAILING_REFIDEL ; BY CPF_CNPJ DESCENDING ANOMES; RUN;
PROC SORT DATA=MAILING_REFIDEL NODUPKEY; BY CPF_CNPJ ; RUN;

%MACRO RET (ANOMES);

DATA RET_FX_&ANOMES.;
SET RET_FX.RET_FIXO_&ANOMES.;
IF TIPO_RETIRADA = "VOL" THEN CV_FX = &ANOMES.; ELSE CV_FX = .;
CT_FX = &ANOMES.;
RUN;

DATA RET_BL_&ANOMES.;
SET RET_BL.RET_BL_&ANOMES.;
IF TIPO_RETIRADA = "VOL" THEN CV_BL = &ANOMES.; ELSE CV_BL = .;
CT_BL = &ANOMES.;
RUN;

DATA RET_TV_&ANOMES.;
SET RET_TV.RET_TV_&ANOMES.;
IF TIPO_RETIRADA = "VOL" THEN CV_TV = &ANOMES.; ELSE CV_TV = .;
CT_TV = &ANOMES.;
RUN;

DATA RET_MV_&ANOMES. (DROP=CPF_CNPJ);
SET RET_MV.RET_MOVEL_&ANOMES.;
IF TIPO_RETIRADA = "VOL" THEN CV_MV = &ANOMES.; ELSE CV_MV = .;
CT_MV = &ANOMES.;
RUN;

%MEND RET;
%RET (201801);
%RET (201802);
%RET (201803);
%RET (201804);
%RET (201805);
%RET (201806);
%RET (201807);
%RET (201808);
%RET (201809);
%RET (201810);
%RET (201811);
%RET (201812);
%RET (201901);
%RET (201902);

DATA RET_FX;
SET RET_FX_201801
	RET_FX_201802
	RET_FX_201803
	RET_FX_201804
	RET_FX_201805
	RET_FX_201806
	RET_FX_201807
	RET_FX_201808
	RET_FX_201809
RET_FX_201810
RET_FX_201811
RET_FX_201812
RET_FX_201901
RET_FX_201902;
RENAME CPFCNPJ = CPF_CNPJ;
RUN;

DATA RET_BL;
SET RET_BL_201801
	RET_BL_201802
	RET_BL_201803
	RET_BL_201804
	RET_BL_201805
	RET_BL_201806
	RET_BL_201807
	RET_BL_201808
	RET_BL_201809
RET_BL_201810
RET_BL_201811
RET_BL_201812
RET_BL_201901
RET_BL_201902;
RENAME CPFCNPJ = CPF_CNPJ;
RUN;

DATA RET_TV;
SET RET_TV_201801
	RET_TV_201802
	RET_TV_201803
	RET_TV_201804
	RET_TV_201805
	RET_TV_201806
	RET_TV_201807
	RET_TV_201808
	RET_TV_201809
RET_TV_201810
RET_TV_201811
RET_TV_201812
RET_TV_201901
RET_TV_201902;
RUN;

DATA RET_MV;
SET RET_MV_201801
	RET_MV_201802
	RET_MV_201803
	RET_MV_201804
	RET_MV_201805
	RET_MV_201806
	RET_MV_201807
	RET_MV_201808
	RET_MV_201809
RET_MV_201810
RET_MV_201811
RET_MV_201812
RET_MV_201901
RET_MV_201902;
RENAME CPFCNPJ = CPF_CNPJ;
RENAME ANOMES_RETIRADA = ANOMES_RETIRADA_STR;
RUN;

DATA RET_MV;
SET RET_MV;
ANOMES_RETIRADA = INPUT(ANOMES_RETIRADA_STR,6.);
RUN;

PROC SORT DATA=RET_FX; BY CPF_CNPJ DESCENDING ANOMES_RETIRADA; RUN;
PROC SORT DATA=RET_FX NODUPKEY	; BY CPF_CNPJ ; RUN;

PROC SORT DATA=RET_BL; BY CPF_CNPJ DESCENDING ANOMES_RETIRADA; RUN;
PROC SORT DATA=RET_BL NODUPKEY	; BY CPF_CNPJ ; RUN;

PROC SORT DATA=RET_TV; BY CPF_CNPJ DESCENDING ANOMES_RETIRADA; RUN;
PROC SORT DATA=RET_TV NODUPKEY	; BY CPF_CNPJ ; RUN;

PROC SORT DATA=RET_MV; BY CPF_CNPJ DESCENDING ANOMES_RETIRADA; RUN;
PROC SORT DATA=RET_MV NODUPKEY	; BY CPF_CNPJ ; RUN;

DATA MAILING_REFIDEL_RET;
MERGE MAILING_REFIDEL 	(IN=A)
	  RET_FX			(IN=B KEEP=CPF_CNPJ CV_FX CT_FX)
	  RET_BL			(IN=C KEEP=CPF_CNPJ CV_BL CT_BL)
	  RET_TV			(IN=D KEEP=CPF_CNPJ CV_TV CT_TV)
RET_MV			(IN=E KEEP=CPF_CNPJ CV_MV CT_MV);
IF A;
BY CPF_CNPJ;
RUN;

PROC SQL;
CREATE TABLE MAILING_REFIDEL_RET2 AS SELECT
A.*,
B.CV_FX,
B.CT_FX,
C.CV_BL,
C.CT_BL,
D.CV_TV,
D.CT_TV,
E.CV_MV,
E.CT_MV
FROM MAILING_REFIDEL A
LEFT JOIN RET_FX B ON A.CPF_CNPJ = B.CPF_CNPJ
LEFT JOIN RET_BL C ON A.CPF_CNPJ = C.CPF_CNPJ
LEFT JOIN RET_TV D ON A.CPF_CNPJ = D.CPF_CNPJ
LEFT JOIN RET_MV E ON A.CPF_CNPJ = E.CPF_CNPJ;
QUIT;
RUN;


PROC SQL;
CREATE TABLE REFIDEL_OIT_RET_AGG AS SELECT
ANOMES
,RESULTADO
,DETALHAMENTO
,TP_BUNDLE_I
,CV_FX
,CV_BL
,CV_TV
,CV_MV
,CT_FX
,CT_BL
,CT_TV
,CT_MV
,COUNT(CPF_CNPJ) AS QTD
FROM MAILING_REFIDEL_RET
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12;
QUIT;


PROC SQL;
CREATE TABLE REFIDEL_OIT_RET_AGG2 AS SELECT
ANOMES
,RESULTADO
,DETALHAMENTO
,TP_BUNDLE_I
,CV_FX
,CV_BL
,CV_TV
,CV_MV
,CT_FX
,CT_BL
,CT_TV
,CT_MV
,COUNT(CPF_CNPJ) AS QTD
FROM MAILING_REFIDEL_RET2
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12;
QUIT;